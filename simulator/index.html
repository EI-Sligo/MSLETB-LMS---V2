<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ElectroLab v3.0 - Professional</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <link rel="stylesheet" href="style.css">

    <script>
        const params = new URLSearchParams(window.location.search);
        // We now also look for 'uid' to know which user is saving files
        if (params.get('auth') !== 'msletb_secure_launch') {
            document.body.innerHTML = `
                <div style="display:flex;height:100vh;justify-content:center;align-items:center;background:#0f172a;color:white;font-family:sans-serif;text-align:center;">
                    <div>
                        <h1 style="color:#ef4444;font-size:3rem;">üö´ Access Denied</h1>
                        <p>You must launch this simulator from the MSLETB Learner Portal.</p>
                        <a href="../index.html" style="color:#3b82f6;text-decoration:underline;">Go to Login</a>
                    </div>
                </div>
            `;
            throw new Error("Unauthorized Access");
        }
    </script>
</head>
<body>

    <div id="sidebar">
        <div class="header">
            <h1>‚ö° ElectroLab v3</h1>
        </div>
        
        <div class="sidebar-tabs">
            <button id="btn-tab-components" class="tab-btn active" onclick="App.switchTab('components')">Components</button>
            <button id="btn-tab-levels" class="tab-btn" onclick="App.switchTab('levels')">Scenarios & Saves</button>
        </div>
        
        <div id="tab-components" class="palette-scroll tab-content active">
            <div class="palette-section">
                <h3>üè† Mains & Protection</h3>
                <button class="palette-btn" onclick="App.addComponent('db_board')">DB Board Enclosure</button>
                <button class="palette-btn" onclick="App.addComponent('service_head')">Mains Head</button>
                <button class="palette-btn" onclick="App.addComponent('main_fuse')">Main Fuse</button>
                <button class="palette-btn" onclick="App.addComponent('rcd')">RCD</button>
                <button class="palette-btn" onclick="App.addComponent('spd_module')">SPD (Surge)</button>
                <button class="palette-btn" onclick="App.addComponent('earth_bar')">Earth Bar</button>
                <button class="palette-btn" onclick="App.addComponent('neutral_bar')">Neutral Bar</button>
                <button class="palette-btn" onclick="App.addComponent('main_switch_100a')">Main Switch 100A</button>
                
                <div style="margin: 5px 0; border-top: 1px dashed #cbd5e1;"></div>
                
                <button class="palette-btn" onclick="App.addComponent('mcb_b6')">MCB B6</button>
                <button class="palette-btn" onclick="App.addComponent('mcb_b10')">MCB B10</button>
                <button class="palette-btn" onclick="App.addComponent('mcb_b16')">MCB B16</button>
                <button class="palette-btn" onclick="App.addComponent('mcb_b20')">MCB B20</button>
                <button class="palette-btn" onclick="App.addComponent('mcb_b32')">MCB B32</button>
                <button class="palette-btn" onclick="App.addComponent('mcb_b40')">MCB B40</button>
                <button class="palette-btn" onclick="App.addComponent('mcb_b50')">MCB B50</button>
                
                <div style="margin: 5px 0; border-top: 1px dashed #cbd5e1;"></div>

                <button class="palette-btn" onclick="App.addComponent('rcbo_b6')">RCBO B6</button>
                <button class="palette-btn" onclick="App.addComponent('rcbo_b10')">RCBO B10</button>
                <button class="palette-btn" onclick="App.addComponent('rcbo_b16')">RCBO B16</button>
                <button class="palette-btn" onclick="App.addComponent('rcbo_b20')">RCBO B20</button>
                <button class="palette-btn" onclick="App.addComponent('rcbo_b32')">RCBO B32</button>
                <button class="palette-btn" onclick="App.addComponent('rcbo_b40')">RCBO B40</button>
                <button class="palette-btn" onclick="App.addComponent('rcbo_b50')">RCBO B50</button>
                
                <button class="palette-btn" style="margin-top:5px" onclick="App.addComponent('contactor_2no')">Contactor 2-Pole</button>
            </div>

            <div class="palette-section">
                <h3>üí° Switches & Loads</h3>
                <button class="palette-btn" onclick="App.addComponent('sw_1way')">Switch 1-Way</button>
                <button class="palette-btn" onclick="App.addComponent('sw_2way')">Switch 2-Way</button>
                <button class="palette-btn" onclick="App.addComponent('sw_inter')">Intermediate Switch</button>
                <button class="palette-btn" onclick="App.addComponent('fcu')">Switched Fused Spur</button> 
                <button class="palette-btn" onclick="App.addComponent('smoke_alarm')">Mains Smoke Alarm</button> 
                <button class="palette-btn" onclick="App.addComponent('lamp')">Lamp</button>
                <button class="palette-btn" onclick="App.addComponent('socket')">Socket</button>
                <button class="palette-btn" onclick="App.addComponent('junction_box')">Junction Box</button>
            </div>

            <div class="palette-section">
                <h3>üç≥ High Power</h3>
                <button class="palette-btn" onclick="App.addComponent('cooker_sw')">Cooker Switch</button>
                <button class="palette-btn" onclick="App.addComponent('sw_sink_bath')">Immersion Switch</button>
                <button class="palette-btn" onclick="App.addComponent('immersion_dual')">Dual Immersion</button>
                <button class="palette-btn" onclick="App.addComponent('fan')">Extractor Fan</button>
            </div>

            <div class="palette-section">
                <h3>‚òÄÔ∏è Renewables & Hybrid</h3>
                <button class="palette-btn" onclick="App.addComponent('pv_panel')">PV Panel (All Black)</button>
                <button class="palette-btn" onclick="App.addComponent('wind_turbine')">Wind Turbine</button>
                <button class="palette-btn" onclick="App.addComponent('inverter')">Hybrid Inverter (Solis)</button>
                <button class="palette-btn" onclick="App.addComponent('battery_ac')">Tesla Powerwall</button>
                <button class="palette-btn" onclick="App.addComponent('battery_dc')">DC Battery (Lithium)</button>
                <button class="palette-btn" onclick="App.addComponent('ev_charger')">Zappi Charger</button>
                <button class="palette-btn" onclick="App.addComponent('changeover_switch')">Changeover Switch (DIN)</button>
                <button class="palette-btn" onclick="App.addComponent('fireman_switch')">Fireman's Switch</button>
                <button class="palette-btn" onclick="App.addComponent('dc_iso')">DC Isolator</button>
                <button class="palette-btn" onclick="App.addComponent('gen_meter')">Generation Meter</button>
                <button class="palette-btn" onclick="App.addComponent('smart_meter')">Smart Meter (DIN)</button>
            </div>

            <div class="palette-section">
                <h3>üè≠ Industrial Power</h3>
                <button class="palette-btn" onclick="App.addComponent('supply_3ph')">3-Phase Supply</button>
                <button class="palette-btn" onclick="App.addComponent('db_3ph')">TPN Distribution Board</button>
                <button class="palette-btn" onclick="App.addComponent('control_panel')">Control Panel (Enclosure)</button>
                <button class="palette-btn" onclick="App.addComponent('mcb_3ph')">3-Phase MCB</button>
                <button class="palette-btn" onclick="App.addComponent('contactor_3ph')">Contactor 3-Pole</button>
                <button class="palette-btn" onclick="App.addComponent('isolator_3ph')">Isolator 3PH</button>
                <button class="palette-btn" onclick="App.addComponent('motor_3ph')">Motor 3PH</button>
                <button class="palette-btn" onclick="App.addComponent('commando_socket')">415V Socket</button>
                <button class="palette-btn" onclick="App.addComponent('estop')">Emergency Stop</button>
                <button class="palette-btn" onclick="App.addComponent('high_bay')">High Bay Light</button>
            </div>

            <div class="palette-section">
                <h3>üéõÔ∏è Industrial Control (24V)</h3>
                <button class="palette-btn" onclick="App.addComponent('plc_psu')">24V PSU (DIN)</button>
                <button class="palette-btn" onclick="App.addComponent('btn_start')">Push Button (NO)</button>
                <button class="palette-btn" onclick="App.addComponent('btn_stop')">Push Button (NC)</button>
                <button class="palette-btn" onclick="App.addComponent('sw_man_auto')">Hand/Off/Auto</button>
                <button class="palette-btn" onclick="App.addComponent('pilot_green')">Pilot Light (Green)</button>
                <button class="palette-btn" onclick="App.addComponent('pilot_red')">Pilot Light (Red)</button>
                <button class="palette-btn" onclick="App.addComponent('plc_mini')">PLC</button>
            </div>
        </div>

        <div id="tab-levels" class="tab-content">
            <div id="level-list-container"></div>
        </div>

        <div class="meter-panel">
            <div id="meter-display">---</div>
            <div class="meter-controls">
                <button id="btn-meter-v" onclick="Meter.setMode('volts')">V~</button>
                <button id="btn-meter-o" onclick="Meter.setMode('ohms')">Œ©</button>
                <button id="btn-meter-m" onclick="Meter.setMode('megger')">MŒ©</button>
                <button id="btn-meter-off" onclick="Meter.setMode('off')" class="active">OFF</button>
            </div>
        </div>

        <div class="controls">
            <label class="control-label">Wire Type / Colour:</label>
            <select id="cable-select" onchange="App.setCable(this.value)">
                <optgroup label="Standard Twin & Earth (Live)">
                    <option value="1.0">1.0 mm¬≤ </option>
                    <option value="1.5">1.5 mm¬≤ </option>
                    <option value="2.5" selected>2.5 mm¬≤ </option>
                    <option value="4.0">4.0 mm¬≤ </option>
                    <option value="6.0">6.0 mm¬≤ </option>
                    <option value="10.0">10.0 mm¬≤ </option>
                    <option value="16.0">16.0 mm¬≤ </option>
                    <option value="25.0">25.0 mm¬≤ </option>
                </optgroup>
                <optgroup label="Specific Colors">
                    <option value="neutral">Neutral (Blue)</option>
                    <option value="earth">Earth (G/Y)</option>
                    <option value="phase_l2">3-Phase L2 (Black)</option>
                    <option value="phase_l3">3-Phase L3 (Grey)</option>
                    <option value="control_pos">Control +24V (Red)</option>
                    <option value="control_neg">Control 0V (Blue)</option>
                </optgroup>
            </select>

            <button id="btn-power" onclick="App.togglePower()">üîå Power ON</button>
            
            <div style="display:flex; gap:5px;">
                <button class="btn-secondary" onclick="App.saveToCloud()">‚òÅÔ∏è Save</button>
                <button class="btn-secondary" onclick="App.clear()">üóëÔ∏è Clear</button>
				<button class="btn-secondary" style="border-color:#16a34a; color:#16a34a;" onclick="App.submitToLMS()">üì§ Submit to Class</button>
            </div>
        </div>
    </div> 

    <div id="main">
        <div id="toolbar">
            <div class="toolbar-left">
                <button id="btn-input-mode" onclick="App.toggleInputMode()">üñ±Ô∏è Input: MOUSE</button>
                
                <div style="border-left:1px solid #cbd5e1; padding-left:10px; display:flex; gap:5px;">
                    <button id="btn-mode-interact" class="active" onclick="App.setToolMode('interact')">üëÜ Interact</button>
                    <button id="btn-mode-wire" onclick="App.setToolMode('wire')">üîå Wire Mode</button>
                    <button id="btn-mode-move" onclick="App.setToolMode('move')">‚úã Move</button>
                </div>

                <button id="btn-wire-order" onclick="App.toggleWireOrder()" style="margin-left:10px;">üîÉ Layers</button>
                <button id="btn-flow" onclick="App.toggleFlowMode()" style="margin-left:5px;">üåä Flow: OFF</button>
            </div>
            <div id="hint-text">Select a mode to begin.</div>
        </div>

        <canvas id="simCanvas"></canvas>
    </div>

    <div id="prop-modal" class="modal">
        <div class="modal-box" style="background:white; color:black; width:300px;">
            <button class="close-modal" onclick="document.getElementById('prop-modal').style.display='none'" style="color:black;">√ó</button>
            <h3>Component Properties</h3>
            
            <label>Label:</label>
            <input type="text" id="prop-label" style="width:100%; margin-bottom:10px;">
            
            <label>Fault Condition:</label>
            <select id="prop-fault" style="width:100%; margin-bottom:15px;">
                <option value="none">None (Normal)</option>
                <option value="open">Open Circuit</option>
                <option value="short_ln">Short Circuit (L-N)</option>
                <option value="earth_le">Earth Fault (L-E)</option>
            </select>
            
            <div style="text-align:right;">
                <button onclick="App.saveProperty()" class="btn-power" style="width:auto; padding:8px 16px;">Save</button>
            </div>
        </div>
    </div>

    <div id="plc-modal" class="modal" onclick="closePLCModal()">
        <div class="modal-box" style="width: 550px; background:#1e293b; color:white;" onclick="event.stopPropagation()">
            <button class="close-modal" onclick="closePLCModal()" style="color:white;">√ó</button>
            <h3 style="margin-top:0; color:#facc15;">üíª PLC Ladder Logic Editor</h3>
            <p style="color:#94a3b8; font-size:12px;">Click slots to configure contacts and coils. Power flows from left to right.</p>
            
            <div id="ladder-container"></div>

            <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:15px;">
                <button class="btn-secondary" onclick="closePLCModal()" style="background:#334155; color:white; border:none; padding: 8px 16px;">Cancel</button>
                <button class="btn-power" onclick="savePLCLogic()" style="background:#22c55e; color:white; border:none; padding: 8px 16px; width:auto;">üíæ Download Program</button>
            </div>
        </div>
    </div>

    <script type="module" src="data/levels.js"></script>
<script type="module" src="core/engine.js"></script>
<script type="module" src="core/renderer.js"></script>
<script type="module" src="core/meter.js"></script>
<script type="module" src="core/interaction.js"></script>
<script type="module" src="components/domestic.js"></script>
<script type="module" src="components/renewables.js"></script>
<script type="module" src="components/industrial.js"></script>
<script type="module" src="main.js"></script>

    <script src="main.js"></script>
</body>

</html>
